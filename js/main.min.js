function isCorrectNote(a){var b=!1;return NOTES.indexOf(a.toUpperCase())>=0?b=!0:console.log(a+": "+WRONG_NOTE_MSG),b}function isCorrectSemitonesSum(a){for(var b=!1,c=0,d=0;d<a.length;d++)c+=a[d];return c==SCALE_SEMITONES_NUMBER?b=!0:console.log(a+": "+WRONG_SEMITONE_NUMBER_MSG),b}function isCorrectScale(a){var b=!1,c=SCALES[a];return void 0!==c?b=isCorrectSemitonesSum(c):console.log(a+": "+WRONG_SCALE_NAME_MSG),b}function isCorrectTuningNotes(a){for(var b=!1,c=0;c<a.length;c++)if(b=isCorrectNote(a[c]),!b)return b;return b}function isCorrectTuning(a){var b=!1;if(a!==CUSTOM_TUNING_VALUE){var c=TUNINGS[a];void 0!==c?b=isCorrectTuningNotes(c):console.log(a+": "+WRONG_TUNING_NAME)}else b=!0;return b}function isCorrectHalfStep(a){return+a>=MIN_HALF_STEP&&+a<=MAX_HALF_STEP}function isCorrectStringsNumber(a){return+a>=MIN_STRINGS_NUMBER&&+a<=MAX_STRINGS_NUMBER}function getScaleSemitones(a){a=a.toLowerCase();var b=DEFAULT_SCALE_SEMITONES;return isCorrectScale(a)&&(b=SCALES[a]),b}function getTuneNotes(a){a=a.toLowerCase();var b=DEFAULT_STRING_TUNES;return isCorrectTuning(a)&&(b=TUNINGS[a].slice()),b}function prevNote(a){if(resultNote="C",isCorrectNote(a)){var b=NOTES.indexOf(a);b--,b<0&&(b=NOTES.length-1),resultNote=NOTES[b]}return resultNote}function nextNote(a){if(resultNote="C",isCorrectNote(a)){var b=NOTES.indexOf(a);b++,b==NOTES.length&&(b=0),resultNote=NOTES[b]}return resultNote}function prevHalfStep(a){return a--,a<MIN_HALF_STEP&&(a=MIN_HALF_STEP),a}function nextHalfStep(a){return a++,a>MAX_HALF_STEP&&(a=MAX_HALF_STEP),a}function getNotesFromSemiTones(a,b){var c=DEFAULT_SCALE_NOTES;if(a=a.toUpperCase(),isCorrectNote(a)&&isCorrectSemitonesSum(b)){c=[];var d=a;c.push(d);for(var e=0;e<b.length;e++){for(var f=1;f<=b[e];f++)d=nextNote(d);c.push(d)}c.pop()}return c}function getSemiTonesPatternForString(a,b,c){for(var d=[],e=0,f=a.indexOf(c);f<0;)c=nextNote(c),f=a.indexOf(c),e++;d.push(e);for(var g=f;g<b.length;g++)d.push(b[g]);for(var g=0;g<f;g++)d.push(b[g]);return d}function sliderLogVal(a,b,c){var d=0,e=100,f=0;if(a>0){var g=Math.log(b),h=Math.log(c),i=(h-g)/(e-d);f=Math.exp(g+i*(a-d))}return f}function getDefaultScaleOptionsFromCookie(){if(void 0!==Cookies.getJSON("defaultScaleOptions")){var a=Cookies.getJSON("defaultScaleOptions");void 0!==a.scale&&isCorrectScale(a.scale)&&(defaultScaleItemOptions.scale=a.scale),void 0!==a.root&&isCorrectNote(a.root)&&(defaultScaleItemOptions.root=a.root),void 0!==a.tuning&&isCorrectTuning(a.tuning)&&(defaultScaleItemOptions.tuning=a.tuning),void 0!==a.halfStep&&isCorrectHalfStep(a.halfStep)&&(defaultScaleItemOptions.halfStep=+a.halfStep),void 0!==a.stringsTunes&&isCorrectTuningNotes(a.stringsTunes)&&(defaultScaleItemOptions.stringsTunes=a.stringsTunes),void 0!==a.stringsNumber&&isCorrectStringsNumber(a.stringsNumber)&&(defaultScaleItemOptions.stringsNumber=+a.stringsNumber)}}function ScalesItem(a){this.id=a,this.scale="major",this.root="C",this.semiTones=DEFAULT_SCALE_SEMITONES,this.scaleNotes=DEFAULT_SCALE_NOTES,this.tuning="standart_e",this.halfStep=0,this.stringsNumber=3,this.stringsTunes=DEFAULT_STRING_TUNES,this.putNotesOnString=function(a){var b=this.getTuneForString(a),c="."+HOR_FRET_CLASS+":eq("+a+")",d=$(c,$("."+NULL_VER_FRET_CLASS+", ."+VER_FRET_CLASS,this.$fretboardBlock),this.$fretboardBlock),e=getSemiTonesPatternForString(this.scaleNotes,this.semiTones,b),f=$("."+NOTE_CLASS,d);$(f).css("display","none");for(var g=b,h=e.shift(),i=0;i<h;i++)g=nextNote(g);for(var j=0,i=h;i<f.length;){$(f[i]).css("display","inline"),$(f[i]).text(g),g==this.root?$(f[i]).toggleClass(NORMAL_NOTE_CLASS,!1).toggleClass(HIGHLIGHTED_NOTE_CLASS,!0):$(f[i]).toggleClass(NORMAL_NOTE_CLASS,!0).toggleClass(HIGHLIGHTED_NOTE_CLASS,!1),i+=e[j%e.length];for(var k=0;k<e[j];k++)g=nextNote(g);j=++j%e.length}},this.putNotesOnAllStrings=function(){for(var a=0;a<this.stringsNumber;a++)this.putNotesOnString(a)},this.incStringsNumber=function(){this.stringsNumber++,this.$stringsNumberBlock.text(""+this.stringsNumber)},this.decStringsNumber=function(){this.stringsNumber--,this.$stringsNumberBlock.text(""+this.stringsNumber)},this.getTuneForString=function(a){return this.stringsTunes[a%this.stringsTunes.length]},this.addString=function(a){var b=this.getTuneForString(a),c=$("."+STRINGS_OPTIONS_BLOCK_CLASS,this.$itemBlock).append(STRING_TUNE_BLOCK_TMPL()),d=c.children().last();$("."+STRING_TUNE_SELECT_CLASS+" :contains('"+b+"')",d).prop("selected",!0);for(var e={currentStringNumber:a+1},f=$("."+NULL_VER_FRET_CLASS+", ."+VER_FRET_CLASS,this.$fretboardBlock),g=!1,h=!1,i=0,j=0;j<f.length;j++)$(f[j]).append(STRING_FRET_TMPL(e)),0==a&&(i=j%12,g=3==i||5==i||7==i||10==i,h=0!=j&&0==i,g?$(f[j]).append(STRING_FRET_MARK_TMPL()):h&&$(f[j]).append(STRING_DOUBLE_FRET_MARK_TMPL()));this.putNotesOnString(a),$("."+STRING_TUNE_SELECT_CLASS,d).change({itemThis:this},this.onStringTuneChange),$("."+LEFT_ARROW_CLASS,d).click({itemThis:this},this.onLeftArrowTuneClick),$("."+RIGHT_ARROW_CLASS,d).click({itemThis:this},this.onRightArrowTuneClick)},this.delLastString=function(){$("."+STRING_TUNE_BLOCK_CLASS,this.$itemBlock).last().remove();for(var a=$("."+NULL_VER_FRET_CLASS+", ."+VER_FRET_CLASS,this.$fretboardBlock),b=0;b<a.length;b++)$("."+HOR_FRET_CLASS,$(a[b])).last().remove()},this.selectCurrentStringsTunes=function(){for(var a=$("."+STRINGS_OPTIONS_BLOCK_CLASS,this.$itemBlock),b=0;b<this.stringsNumber;b++)a.find("."+STRING_TUNE_SELECT_CLASS+":eq("+b+") :contains('"+this.getTuneForString(b)+"')").prop("selected",!0)},this.selectCurrentTuning=function(){this.$itemBlock.find("."+TUNING_SELECT_CLASS+" [value='"+this.tuning+"']").prop("selected",!0)},this.selectCurrentScale=function(){$("."+SCALE_SELECT_CLASS+" [value='"+this.scale+"']",this.$itemBlock).prop("selected",!0)},this.selectCurrentHalfStep=function(){$("."+HALF_STEP_SELECT_CLASS+" [value='"+this.halfStep+"']",this.$itemBlock).prop("selected",!0)},this.moveTuning=function(a,b){for(var c=1;c<=a;c++)for(var d=0;d<this.stringsTunes.length;d++)b?this.stringsTunes[d]=nextNote(this.stringsTunes[d]):this.stringsTunes[d]=prevNote(this.stringsTunes[d])},this.changeScaleNotesBlock=function(){$("."+SCALE_NOTES_CLASS,this.$itemBlock).remove();var a=this.scaleNotes;a.push(this.root);var b={root:this.root,semiTones:this.semiTones,notes:a};$("."+SCALE_NOTES_BLOCK_CLASS,this.$itemBlock).append(SCALE_NOTES_TMPL(b))},this.onScaleChange=function(a){var b=a.data.itemThis,c=$(this).val().toLowerCase();isCorrectScale(c)&&(b.scale=c,b.semiTones=getScaleSemitones(c),b.scaleNotes=getNotesFromSemiTones(b.root,b.semiTones),b.putNotesOnAllStrings(),b.changeScaleNotesBlock())},this.onStringTuneChange=function(a){var b=a.data.itemThis,c=$("."+STRINGS_OPTIONS_BLOCK_CLASS,a.data.itemThis.$itemBlock),d=$(this).val(),e=$("."+STRING_TUNE_SELECT_CLASS,c).index(this);b.stringsTunes[e]=d,b.putNotesOnString(e),b.tuning=CUSTOM_TUNING_VALUE,b.selectCurrentTuning()},this.onLeftArrowTuneClick=function(a){var b=a.data.itemThis,c=$("."+STRINGS_OPTIONS_BLOCK_CLASS,a.data.itemThis.$itemBlock),d=$("."+LEFT_ARROW_CLASS,c).index(this),e=b.stringsTunes[d];e=prevNote(e),b.stringsTunes[d]=e,$("."+STRING_TUNE_SELECT_CLASS+":eq("+d+") :contains('"+e+"')",c).prop("selected",!0),b.putNotesOnString(d),b.tuning=CUSTOM_TUNING_VALUE,b.selectCurrentTuning()},this.onRightArrowTuneClick=function(a){var b=a.data.itemThis,c=$("."+STRINGS_OPTIONS_BLOCK_CLASS,a.data.itemThis.$itemBlock),d=$("."+RIGHT_ARROW_CLASS,c).index(this),e=b.stringsTunes[d];e=nextNote(e),b.stringsTunes[d]=e,$("."+STRING_TUNE_SELECT_CLASS+":eq("+d+") :contains('"+e+"')",c).prop("selected",!0),b.putNotesOnString(d),b.tuning=CUSTOM_TUNING_VALUE,b.selectCurrentTuning()},this.onTuningChange=function(a){var b=a.data.itemThis,c=$(this).val().toLowerCase();if(c==CUSTOM_TUNING_VALUE)b.tuning=c;else if(isCorrectTuning(c)){b.tuning=c,b.stringsTunes=getTuneNotes(c);var d=Math.abs(b.halfStep),e=b.halfStep>0;b.moveTuning(d,e),b.putNotesOnAllStrings(),b.selectCurrentStringsTunes()}},this.onHalfStepChange=function(a){var b=a.data.itemThis,c=b.halfStep,d=$(this).val().replace(/[^-0-9]/gim,"");d=+d,b.halfStep=d;var e=d>c,f=Math.abs(d-c);b.moveTuning(f,e),b.selectCurrentStringsTunes(),b.putNotesOnAllStrings()},this.onLeftArrowHalfStepClick=function(a){var b=a.data.itemThis,c=b.halfStep;c!=-MAX_HALF_STEP&&(c=prevHalfStep(c),b.halfStep=c,b.moveTuning(1,!1),b.selectCurrentStringsTunes(),b.putNotesOnAllStrings(),b.selectCurrentHalfStep())},this.onRightArrowHalfStepCLick=function(a){var b=a.data.itemThis,c=b.halfStep;c!=MAX_HALF_STEP&&(c=nextHalfStep(c),b.halfStep=c,b.moveTuning(1,!0),b.selectCurrentStringsTunes(),b.putNotesOnAllStrings(),b.selectCurrentHalfStep())},this.onRootNoteChange=function(a){var b=a.data.itemThis,c=$(this).text();isCorrectNote(c)&&(b.root=c.toUpperCase(),$(" ."+ROOT_NOTE_CLASS+"."+SELECTED_TEXT_CLASS,b.$itemBlock).toggleClass(SELECTED_TEXT_CLASS,!1),$(this).toggleClass(SELECTED_TEXT_CLASS,!0),b.scaleNotes=getNotesFromSemiTones(b.root,b.semiTones),b.changeScaleNotesBlock(),b.putNotesOnAllStrings())},this.onAddStringButton=function(a){var b=a.data.itemThis,c=b.stringsNumber;c<MAX_STRINGS_NUMBER&&(b.addString(c),b.incStringsNumber())},this.onDelStringButton=function(a){var b=a.data.itemThis,c=b.stringsNumber;c>MIN_STRINGS_NUMBER&&(b.delLastString(),b.decStringsNumber())},this.onCloseButton=function(a){var b=a.data.itemThis;b.$itemBlock.hide(200,function(){$(this).remove()}),deleteItem(b.id)},this.onSetDefaultButton=function(a){var b=a.data.itemThis;defaultScaleItemOptions.scale=b.scale,defaultScaleItemOptions.root=b.root,defaultScaleItemOptions.semiTones=b.semiTones,defaultScaleItemOptions.tuning=b.tuning,defaultScaleItemOptions.halfStep=b.halfStep,defaultScaleItemOptions.stringsTunes=b.stringsTunes,defaultScaleItemOptions.stringsNumber=b.stringsNumber,Cookies.set("defaultScaleOptions",defaultScaleItemOptions,{expires:DEFAULT_SCALE_OPTIONS_EXPIRE_DAYS})},this.initStrings=function(){for(var a=0;a<FRETS_NUMBER;a++)this.$fretboardBlock.children().last().before(STRING_VER_FRET_TMPL());for(var a=0;a<this.stringsNumber;a++)this.addString(a),this.$stringsNumberBlock.text(""+this.stringsNumber);this.selectCurrentStringsTunes()},this.readDefaultScaleItemOptions=function(){this.scale=defaultScaleItemOptions.scale,this.root=defaultScaleItemOptions.root,this.semiTones=getScaleSemitones(this.scale),this.scaleNotes=getNotesFromSemiTones(this.root,this.semiTones),this.tuning=defaultScaleItemOptions.tuning,this.halfStep=defaultScaleItemOptions.halfStep,this.stringsTunes=defaultScaleItemOptions.stringsTunes;var a=defaultScaleItemOptions.stringsNumber;a<MIN_STRINGS_NUMBER&&(a=MIN_STRINGS_NUMBER),this.stringsNumber=a},this.initAnimation=function(){this.$itemBlock.hide(),this.$itemBlock.show(200)},this.init=function(){$addNewItemBtn.before(SCALES_ITEM_BLOCK_TMPL({id:this.id})),this.$itemBlock=$("#"+this.id),this.$stringsNumberBlock=$("."+STRING_NUMBER_CLASS,this.$itemBlock),this.$fretboardBlock=$("."+FRETBOARD_CLASS,this.$itemBlock),this.initAnimation(),this.readDefaultScaleItemOptions(),this.initStrings(),this.changeScaleNotesBlock(),this.selectCurrentTuning(),this.selectCurrentScale(),this.selectCurrentHalfStep(),this.putNotesOnAllStrings(),$("."+SCALE_SELECT_CLASS,this.$itemBlock).change({itemThis:this},this.onScaleChange),$("."+TUNING_SELECT_CLASS,this.$itemBlock).change({itemThis:this},this.onTuningChange),$("."+HALF_STEP_SELECT_CLASS,this.$itemBlock).change({itemThis:this},this.onHalfStepChange),this.$itemBlock.find("."+HALF_STEP_BLOCK_CLASS).find("."+LEFT_ARROW_CLASS).click({itemThis:this},this.onLeftArrowHalfStepClick),this.$itemBlock.find("."+HALF_STEP_BLOCK_CLASS).find("."+RIGHT_ARROW_CLASS).click({itemThis:this},this.onRightArrowHalfStepCLick),$("."+SCALE_NOTES_BLOCK_CLASS,this.$itemBlock).on("click","."+ROOT_NOTE_CLASS,{itemThis:this},this.onRootNoteChange),$("."+ADD_STRING_BTN_CLASS,this.$itemBlock).click({itemThis:this},this.onAddStringButton),$("."+DEL_STRING_BTN_CLASS,this.$itemBlock).click({itemThis:this},this.onDelStringButton),$("."+CLOSE_BTN_CLASS,this.$itemBlock).click({itemThis:this},this.onCloseButton),$("."+SET_DEFAULT_BTN_CLASS,this.$itemBlock).click({itemThis:this},this.onSetDefaultButton)},this.init()}function createNewItemID(){for(var a=0;usedIDs.indexOf("menuItem"+a)>=0;)a++;return"menuItem"+a}function createNewItem(){var a=createNewItemID();menuItems.length<MAX_ITEMS_NUMBER?(menuItems.push(new ScalesItem(a)),usedIDs.push(a)):$addNewItemBtn.hide(200)}function deleteItem(a){menuItems.length==MAX_ITEMS_NUMBER&&$addNewItemBtn.show(200);for(var b=0;b<menuItems.length;b++)menuItems[b].id===a&&(menuItems.splice(b,1),usedIDs.splice(usedIDs.indexOf(a),1))}var SCALE_SEMITONES_NUMBER=12,MAX_HALF_STEP=11,MIN_HALF_STEP=-11,MAX_STRINGS_NUMBER=12,MIN_STRINGS_NUMBER=3,MAX_ITEMS_NUMBER=5,FRETS_NUMBER=24,DEFAULT_METR_BEATS=4,DEFAULT_METR_BEAT_VAL=4,DEFAULT_METR_VOLUME=50,DEFAULT_METR_TEMPO=120,MIN_BEATS=1,MAX_BEATS=16,MIN_BEAT_VAL=1,MAX_BEAT_VAL=32,MIN_TEMPO=40,MAX_TEMPO=320,DEFAULT_SCALE_OPTIONS_EXPIRE_DAYS=1,NOTES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],DEFAULT_SCALE_SEMITONES=[2,2,1,2,2,2,1],DEFAULT_STRING_TUNES=["E","B","G","D","A","E","B","F#","C#","G#","D#","A#"],DEFAULT_SCALE_NOTES=["C","D","E","F","G","A","B"],SCALES={major:[2,2,1,2,2,2,1],aeolian:[2,2,1,2,2,2,1],minor:[2,1,2,2,1,2,2],ionian:[2,1,2,2,1,2,2],harmonic_min:[2,1,2,2,1,3,1],chromatic:[1,1,1,1,1,1,1,1,1,1,1,1],major_arp:[4,3,5],dorian:[2,1,2,2,2,1,2],phrygian:[1,2,2,2,1,2,2],lydian:[2,2,2,1,2,2,1],myxolydian:[2,2,1,2,2,1,2],locrian:[1,2,2,1,2,2,2],melodic_min:[2,1,2,2,2,2,1],alt_dom:[1,2,1,2,2,2,2],sup_locrian:[1,2,1,2,2,2,2],dim_whole_tone:[1,2,1,2,2,2,2],alt_scale:[1,2,1,2,2,2,2],blues_min_hex:[3,2,1,1,3,2],blues_pent:[3,2,1,4,2],blues:[3,2,1,1,3,1,1],major_pent:[2,2,3,2,3],suspended_pent:[2,3,2,3,2],dorian_pent:[2,3,2,3,2],phrygian_pent:[3,2,3,2,2],myxolydian_pent:[2,3,2,2,3],aeolian_pent:[3,2,2,3,2],minor_pent:[3,2,2,3,2],major_beb:[2,2,1,2,1,1,2,1],minor_beb:[2,1,1,1,2,2,1,2],dom_beb:[2,2,1,2,2,1,1,1],dorian_beb:[2,1,1,1,2,2,1,2],whole_tone:[2,2,2,2,2,2],whole_half_tone:[2,1,2,1,2,1,2,1],half_whole_tone:[1,2,1,2,1,2,1,2],dim:[2,1,2,1,2,1,2,1],dom_dim:[1,2,1,2,1,2,1,2],symm_dim:[1,2,1,2,1,2,1,2],spanish:[1,2,2,2,1,2,2],acoustic:[2,2,2,1,2,1,2],bartok:[2,2,2,1,2,1,2]},TUNINGS={standart_e:["E","B","G","D","A","E","B","F#","C#","G#","D#","A#"],standart_e_bass:["G","D","A","E","B"],drop_d_6:["E","B","G","D","A","D","B","F#","C#","G#","D#","A#"],drop_a_7:["E","B","G","D","A","E","A","F#","C#","G#","D#","A#"],drop_e_8:["E","B","G","D","A","E","B","E","C#","G#","D#","A#"]},CUSTOM_TUNING_VALUE="custom",STRING_NUMBER_CLASS="strings_number",SCALE_SELECT_CLASS="scale_select",FRETBOARD_CLASS="fretboard",HOR_FRET_CLASS="fret_hor",NULL_VER_FRET_CLASS="fret_null",VER_FRET_CLASS="fret_ver",NOTE_CLASS="note",NORMAL_NOTE_CLASS="normal_note",HIGHLIGHTED_NOTE_CLASS="highlighted_note",STRINGS_OPTIONS_BLOCK_CLASS="strings_options_block",STRING_TUNE_BLOCK_CLASS="string_tune",STRING_TUNE_SELECT_CLASS="string_tune_select",LEFT_ARROW_CLASS="left_arrow",RIGHT_ARROW_CLASS="right_arrow",HALF_STEP_BLOCK_CLASS="half_step_block",HALF_STEP_SELECT_CLASS="half_step_select",TUNING_SELECT_CLASS="tuning_select",ROOT_NOTE_CLASS="root_note",SELECTED_TEXT_CLASS="selected_text",SCALE_NOTES_BLOCK_CLASS="scale_notes_and_semitones_block",SCALE_NOTES_CLASS="scale_notes",ADD_STRING_BTN_CLASS="add_string",DEL_STRING_BTN_CLASS="delete_string",CLOSE_BTN_CLASS="close_btn",SET_DEFAULT_BTN_CLASS="set_default_btn",METRONOME_DISABLED_ID="metronome_disabled_block",ADD_NEW_ITEM_BTN_ID="add_new_item_btn",METR_PLAY_BTN_ID="metronome_play_btn",METR_STOP_BTN_ID="metronome_stop_btn",METR_VOLUME_RANGE_ID="metronome_volume_range",METR_TEMPO_RANGE_ID="metronome_tempo_range",METR_TEMPO_INPUT_ID="metronome_tempo_input",METR_TEMPO_LEFT_ARROW_ID="metronome_tempo_left_arrow",METR_TEMPO_RIGHT_ARROW_ID="metronome_tempo_right_arrow",METR_BEATS_SELECT_ID="metronome_beats_select",METR_BEATS_LEFT_ARROW_ID="metronome_beats_left_arrow",METR_BEATS_RIGHT_ARROW_ID="metronome_beats_right_arrow",METR_BEAT_VAL_SELECT_ID="metronome_beat_val_select",METR_BEAT_VAL_LEFT_ARROW_ID="metronome_beat_val_left_arrow",METR_BEAT_VAL_RIGHT_ARROW_ID="metronome_beat_val_right_arrow",WRONG_SEMITONE_NUMBER_MSG="Wrong sum of semitones, must be equal to "+SCALE_SEMITONES_NUMBER,WRONG_ROOT_NOTE_MSG="Wrong root note",WRONG_NOTE_MSG="Wrong note",WRONG_SCALE_NAME_MSG="Wrong scale name (value)",WRONG_STRING_TUNE_NOTE_MSG="Wrong string tune note",WRONG_TUNING_NAME="Wrong tuning name (value)",WEB_AUDIO_INIT_ERR_MSG="Web audio initialization error",WORKER_INIT_ERR_MSG="Web worker initialization error",SCALE_NOTES_TMPL=doT.template($("#scale_notes_tmpl").html()),STRING_VER_FRET_TMPL=doT.template($("#string_ver_fret_tmpl").html()),STRING_FRET_TMPL=doT.template($("#string_hor_fret_tmpl").html()),STRING_FRET_MARK_TMPL=doT.template($("#fretboard_single_mark").html()),STRING_DOUBLE_FRET_MARK_TMPL=doT.template($("#fretboard_double_mark").html()),STRING_TUNE_BLOCK_TMPL=doT.template($("#string_tune_block_tmpl").html()),SCALES_ITEM_BLOCK_TMPL=doT.template($("#scales_item_tmpl").html()),defaultScaleItemOptions={scale:"major",root:"C",tuning:"standart_e",halfStep:0,stringsTunes:DEFAULT_STRING_TUNES,stringsNumber:6},menuItems=[],usedIDs=[],$addNewItemBtn=$("#"+ADD_NEW_ITEM_BTN_ID);$addNewItemBtn.click(createNewItem),getDefaultScaleOptionsFromCookie(),createNewItem();var audioCtx,worker,isMetronomeCanWork=!0;try{audioCtx=new AudioContext}catch(a){console.log(WEB_AUDIO_INIT_ERR_MSG),isMetronomeCanWork=!1}try{worker=new Worker("js/worker.js")}catch(a){console.log(WORKER_INIT_ERR_MSG),isMetronomeCanWork=!1}if(isMetronomeCanWork){var metronome={beats:DEFAULT_METR_BEATS,beatValue:DEFAULT_METR_BEAT_VAL,volume:sliderLogVal(DEFAULT_METR_VOLUME,1,100)/100,tempo:DEFAULT_METR_TEMPO,gainNode:audioCtx.createGain(),beatNumber:0,beatsQueue:[],$playBtn:$("#"+METR_PLAY_BTN_ID),$stopBtn:$("#"+METR_STOP_BTN_ID),$volumeRange:$("#"+METR_VOLUME_RANGE_ID),$tempoRange:$("#"+METR_TEMPO_RANGE_ID),$tempoInput:$("#"+METR_TEMPO_INPUT_ID),$tempoLeftArrow:$("#"+METR_TEMPO_LEFT_ARROW_ID),$tempoRightArrow:$("#"+METR_TEMPO_RIGHT_ARROW_ID),$beatsSelect:$("#"+METR_BEATS_SELECT_ID),$beatsLeftArrow:$("#"+METR_BEATS_LEFT_ARROW_ID),$beatsRightArrow:$("#"+METR_BEATS_RIGHT_ARROW_ID),$beatValSelect:$("#"+METR_BEAT_VAL_SELECT_ID),$beatValLeftArrow:$("#"+METR_BEAT_VAL_LEFT_ARROW_ID),$beatValRightArrow:$("#"+METR_BEAT_VAL_RIGHT_ARROW_ID),scheduleBeatFromQueue:function(){if(this.beatsQueue.length>0){beat=this.beatsQueue.shift();var a=audioCtx.createOscillator();a.type="square";var b=440;0==this.beatNumber&&(b=640),a.frequency.value=b,a.connect(this.gainNode),a.start(beat.time),a.stop(beat.time+50/b)}},beatsScheduler:function(){if(itemThis=metronome,itemThis.beatsQueue.length>0){var a=audioCtx.currentTime,b=itemThis.beatsQueue[itemThis.beatsQueue.length-1],c=240/itemThis.beatValue/itemThis.tempo;a+c>=b.time&&(itemThis.beatsQueue.push({time:b.time+c,number:itemThis.beatNumber}),itemThis.scheduleBeatFromQueue(),itemThis.beatNumber=(itemThis.beatNumber+1)%itemThis.beats)}else itemThis.beatsQueue.push({time:audioCtx.currentTime,number:itemThis.beatNumber})},onPlayBtn:function(a){itemThis=a.data.itemThis,$(this).hide(),itemThis.$stopBtn.show(),itemThis.beatNumber=0,worker.postMessage("start")},onStopBtn:function(a){itemThis=a.data.itemThis,itemThis.beatsQueue=[],$(this).hide(),itemThis.$playBtn.show(),worker.postMessage("stop")},onVolumeChange:function(a){itemThis=a.data.itemThis;var b=$(this).val();b=sliderLogVal(+b,1,100),b/=100,itemThis.gainNode.gain.value=b,itemThis.volume=b},onTempoChange:function(a){itemThis=a.data.itemThis;var b=$(this).val();itemThis.$tempoInput.val(b),b=+b,itemThis.tempo=b},onTempoInputChange:function(a){itemThis=a.data.itemThis;var b=$(this).val().replace(/[^,.0-9]/gim,"").replace(/[,.]+/gim,".");b=parseFloat(b),b<MIN_TEMPO?b=MIN_TEMPO:b>MAX_TEMPO&&(b=MAX_TEMPO),itemThis.tempo=b,$(this).val(b),itemThis.$tempoRange.val(b)},onTempoLeftArrow:function(a){itemThis=a.data.itemThis;var b=itemThis.$tempoInput.val();b>MIN_TEMPO&&(b--,itemThis.tempo=b,itemThis.$tempoInput.val(b),itemThis.$tempoRange.val(b))},onTempoRightArrow:function(a){itemThis=a.data.itemThis;var b=itemThis.$tempoInput.val();b<MAX_TEMPO&&(b++,itemThis.tempo=b,itemThis.$tempoInput.val(b),itemThis.$tempoRange.val(b))},onBeatsChange:function(a){itemThis=a.data.itemThis;var b=$(this).val();b=+b,itemThis.beats=b},onBeatsLeftArrow:function(a){itemThis=a.data.itemThis;var b=itemThis.beats;b<=MIN_BEATS||(b--,itemThis.beats=b,itemThis.$beatsSelect.find("[value='"+b+"']").prop("selected",!0))},onBeatsRightArrow:function(a){itemThis=a.data.itemThis;var b=itemThis.beats;b>=MAX_BEATS||(b++,itemThis.beats=b,itemThis.$beatsSelect.find("[value='"+b+"']").prop("selected",!0))},onBeatValChange:function(a){itemThis=a.data.itemThis;var b=$(this).val();b=+b,itemThis.beatValue=b},onBeatValLeftArrow:function(a){itemThis=a.data.itemThis;var b=itemThis.beatValue;b<=MIN_BEAT_VAL||(b/=2,itemThis.beatValue=b,itemThis.$beatValSelect.find("[value='"+b+"']").prop("selected",!0))},onBeatValRightArrow:function(a){itemThis=a.data.itemThis;var b=itemThis.beatValue;b>=MAX_BEAT_VAL||(b*=2,itemThis.beatValue=b,itemThis.$beatValSelect.find("[value='"+b+"']").prop("selected",!0))},workerTick:function(a){var b=a.data,c=metronome;"tick"==b&&c.beatsScheduler()},init:function(){this.$stopBtn.hide(),this.tempo=+this.$tempoRange.val();var a=sliderLogVal(+this.$volumeRange.val(),1,100);this.volume=a/100,this.gainNode.gain.value=this.volume,this.gainNode.connect(audioCtx.destination),worker.onmessage=this.workerTick,this.$tempoInput.val(this.tempo),this.beats=this.$beatsSelect.val(),this.beatValue=this.$beatValSelect.val(),this.$playBtn.click({itemThis:this},this.onPlayBtn),this.$stopBtn.click({itemThis:this},this.onStopBtn),this.$volumeRange.change({itemThis:this},this.onVolumeChange),this.$volumeRange.on("input",{itemThis:this},this.onVolumeChange),this.$tempoRange.change({itemThis:this},this.onTempoChange),this.$tempoRange.on("input",{itemThis:this},this.onTempoChange),this.$tempoInput.change({itemThis:this},this.onTempoInputChange),this.$tempoLeftArrow.click({itemThis:this},this.onTempoLeftArrow),this.$tempoRightArrow.click({itemThis:this},this.onTempoRightArrow),this.$beatsSelect.change({itemThis:this},this.onBeatsChange),this.$beatsLeftArrow.click({itemThis:this},this.onBeatsLeftArrow),this.$beatsRightArrow.click({itemThis:this},this.onBeatsRightArrow),this.$beatValSelect.change({itemThis:this},this.onBeatValChange),this.$beatValLeftArrow.click({itemThis:this},this.onBeatValLeftArrow),this.$beatValRightArrow.click({itemThis:this},this.onBeatValRightArrow)}};metronome.init()}else $("#"+METRONOME_DISABLED_ID).show(0);
