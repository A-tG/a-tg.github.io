(function(){var e=e||{};e.scope={};e.ASSUME_ES5=!1;e.ASSUME_NO_NATIVE_MAP=!1;e.ASSUME_NO_NATIVE_SET=!1;e.defineProperty=e.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};e.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};e.global=e.getGlobal(this);
e.polyfill=function(a,b){if(b){var c=e.global;a=a.split(".");for(var d=0;d<a.length-1;d++){var f=a[d];f in c||(c[f]={});c=c[f]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&e.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};e.polyfill("Number.isFinite",function(a){return a?a:function(a){return"number"!==typeof a?!1:!isNaN(a)&&Infinity!==a&&-Infinity!==a}},"es6","es3");
e.polyfill("Number.isInteger",function(a){return a?a:function(a){return Number.isFinite(a)?a===Math.floor(a):!1}},"es6","es3");e.findInternal=function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,f=0;f<d;f++){var g=a[f];if(b.call(c,g,f,a))return{i:f,v:g}}return{i:-1,v:void 0}};e.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return e.findInternal(this,a,c).v}},"es6","es3");
var h=["day","night"],k=doT.template($("#metronome_datalist_option_tmpl").html()),l=doT.template($("#item_base_tmpl").html()),m=doT.template($("#strings_btns_tmpl").html()),n=doT.template($("#lh_toggle_tmpl").html()),p=doT.template($("#neck_tmpl").html()),q=doT.template($("#tuning_options_tmpl").html()),r=doT.template($("#scales_select_tmpl").html()),t=doT.template($("#scales_options_tmpl").html()),u=doT.template($("#scale_notes_tmpl").html()),v=doT.template($("#string_ver_fret_tmpl").html()),w=doT.template($("#string_hor_fret_tmpl").html()),
x=doT.template($("#fretboard_single_mark").html()),y=doT.template($("#fretboard_double_mark").html()),z=doT.template($("#fret_dot_tmpl").html()),A=doT.template($("#fret_double_dot_tmpl").html()),aa=doT.template($("#string_tune_block_tmpl").html());function C(a){this._noteName=this.defaultNoteName();this._isArgReceived(a)&&this.set(a)}C.prototype._IS_DEBUG=!0;C.prototype._ALL_NOTES="C C# D D# E F F# G G# A A# B".split(" ");C.prototype._FLAT_SYMBOL="b";C.prototype._SHARP_SYMBOL="#";C.prototype._isArgReceived=function(a){return void 0!==a};C.prototype._validateSemiTonesArg=function(a){return!this._isArgReceived(a)||"number"!=typeof a||isNaN(a)?(this._IS_DEBUG&&console.error("Invalid semitones number argument"),0):a};
C.prototype._noteNameArg=function(a){return this._isArgReceived(a)?a:this._noteName};C.prototype._isValid=function(a){return this._isValidNormal(a)||this._isValidFlat(a)||this._isAltSharp(a)};C.prototype._isValidNormal=function(a){return-1<this._ALL_NOTES.indexOf(a)};C.prototype._isValidFlat=function(a){return a[a.length-1]===this._FLAT_SYMBOL&&this._isValidNormal(a.slice(0,-1))};C.prototype._isValidSharp=function(a){return a[a.length-1]===this._SHARP_SYMBOL&&this._isValidNormal(a)};
C.prototype._isAltSharp=function(a){return a[a.length-1]===this._SHARP_SYMBOL&&this._isValidNormal(a.slice(0,-1))&&!this._isValidNormal(a)};C.prototype._higher=function(){this._noteName=this.higherName(this._noteName);return this};C.prototype._lower=function(){this._noteName=this.lowerName(this._noteName);return this};C.prototype._higherST=function(a){this._noteName=this.higherSTName(a,this._noteName);return this};
C.prototype._lowerST=function(a){this._noteName=this.lowerSTName(a,this._noteName);return this};C.prototype.set=function(a){this._noteName=this.validateNoteName(a);return this};C.prototype.setName=C.prototype.set;C.prototype.get=function(){return this._noteName};C.prototype.getName=C.prototype.get;C.prototype.getCopy=function(){var a=this.getName();return new C(a)};C.prototype.defaultNoteName=function(){return this._ALL_NOTES[0]};C.prototype.getAllNotes=function(){return this._ALL_NOTES.slice()};
C.prototype.isValid=function(a){if(this._isValid(a))return!0;this._IS_DEBUG&&console.error("Invalid note name: "+a);return!1};C.prototype.isValidNormal=function(a){if(this._isValidNormal(a))return!0;this._IS_DEBUG&&console.error("Invalid note normal name: "+a);return!1};C.prototype.isValidFlat=function(a){if(this._isValidFlat(a))return!0;this._IS_DEBUG&&console.error("Invalid flat note name: "+a);return!1};
C.prototype.isValidSharp=function(a){if(this._isValidSharp(a))return!0;this._IS_DEBUG&&console.error("Invalid sharp note name: "+a);return!1};C.prototype.isAltSharp=function(a){if(this._isAltSharp(a))return!0;this._IS_DEBUG&&console.error("Invalid alternative sharp note name: "+a);return!1};
C.prototype.validateNoteName=function(a){var b=this.defaultNoteName();if("string"!==typeof a)return this._IS_DEBUG&&console.error("Note name must be a String"),b;this.isValid(a)&&(this._isValidNormal(a)?b=a:this._isValidFlat(a)?b=this.flatToNormal(a):this._isAltSharp(a)&&(b=this.sharpToNormal(a)));return b};C.prototype.normalSharpToFlat=function(a){a=this._noteNameArg(a);return this._isValidSharp(a)?this.sharpToFlat(a):a};
C.prototype.flatToNormal=function(a){a=this._noteNameArg(a);var b=this.defaultNoteName();this.isValidFlat(a)&&(b=this.lowerName(a.slice(0,-1)));return b};C.prototype.sharpToFlat=function(a){a=this._noteNameArg(a);var b=this.defaultNoteName();this.isValidSharp(a)&&(b=this.higherName(a),b+=this._FLAT_SYMBOL);return b};C.prototype.sharpToNormal=function(a){a=this._noteNameArg(a);var b=this.defaultNoteName();this.isAltSharp(a)&&(b=this.higherName(a.slice(0,-1)));return b};
C.prototype.higherName=function(a){a=this.validateNoteName(this._noteNameArg(a));a=this._ALL_NOTES.indexOf(a);++a==this._ALL_NOTES.length&&(a=0);return this._ALL_NOTES[a]};C.prototype.higher=function(a){return 0==arguments.length?this._higher():new C(this.higherName(a))};C.prototype.lowerName=function(a){a=this.validateNoteName(this._noteNameArg(a));a=this._ALL_NOTES.indexOf(a);0>--a&&(a=this._ALL_NOTES.length-1);return this._ALL_NOTES[a]};
C.prototype.lower=function(a){return 0==arguments.length?this._lower():new C(this.lowerName(a))};C.prototype.higherSTName=function(a,b){var c=this.validateNoteName(this._noteNameArg(b));a=this._validateSemiTonesArg(a);if(0>a)return this.lowerSTName(-a,b);for(b=0;b<a;b++)c=this.higherName(c);return c};C.prototype.higherST=function(a,b){return 1==arguments.length?this._higherST(a):new C(this.higherSTName(a,b))};
C.prototype.lowerSTName=function(a,b){var c=this.validateNoteName(this._noteNameArg(b));a=this._validateSemiTonesArg(a);if(0>a)return this.higherSTName(-a,b);for(b=0;b<a;b++)c=this.lowerName(c);return c};C.prototype.lowerST=function(a,b){return 1==arguments.length?this._lowerST(a):new C(this.lowerSTName(a,b))};C.prototype.serialize=function(){return this.normalSharpToFlat()};C.prototype.deserialize=C.prototype.set;C.prototype.toJSON=C.prototype.serialize;C.prototype.toString=C.prototype.getName;
C.prototype.valueOf=function(){return this._ALL_NOTES.indexOf(this._noteName)+1};function D(a,b){this._root=new C;this._name=this.getDefaultName();this._semiTones=this.getDefaultSemiTones();this._isArgReceived(a)&&this.setName(a);this._isArgReceived(b)&&this.setRoot(b)}D.prototype._IS_DEBUG=!0;
D.prototype._ALL_SCALES={major:[2,2,1,2,2,2,1],ionian:[2,2,1,2,2,2,1],aeolian:[2,1,2,2,1,2,2],minor:[2,1,2,2,1,2,2],harmonic_min:[2,1,2,2,1,3,1],chromatic:[1,1,1,1,1,1,1,1,1,1,1,1],dorian:[2,1,2,2,2,1,2],phrygian:[1,2,2,2,1,2,2],phrygian_dom:[1,3,1,2,1,2,2],lydian:[2,2,2,1,2,2,1],myxolydian:[2,2,1,2,2,1,2],locrian:[1,2,2,1,2,2,2],melodic_min:[2,1,2,2,2,2,1],alt_dom:[1,2,1,2,2,2,2],sup_locrian:[1,2,1,2,2,2,2],dim_whole_tone:[1,2,1,2,2,2,2],alt_scale:[1,2,1,2,2,2,2],blues_min_hex:[3,2,1,1,3,2],blues_pent:[3,
2,1,4,2],blues:[3,2,1,1,3,1,1],major_pent:[2,2,3,2,3],suspended_pent:[2,3,2,3,2],dorian_pent:[2,3,2,3,2],phrygian_pent:[3,2,3,2,2],myxolydian_pent:[2,3,2,2,3],aeolian_pent:[3,2,2,3,2],minor_pent:[3,2,2,3,2],major_beb:[2,2,1,2,1,1,2,1],minor_beb:[2,1,1,1,2,2,1,2],dom_beb:[2,2,1,2,2,1,1,1],dorian_beb:[2,1,1,1,2,2,1,2],whole_tone:[2,2,2,2,2,2],whole_half_tone:[2,1,2,1,2,1,2,1],half_whole_tone:[1,2,1,2,1,2,1,2],dim:[2,1,2,1,2,1,2,1],dom_dim:[1,2,1,2,1,2,1,2],symm_dim:[1,2,1,2,1,2,1,2],spanish:[1,2,2,
2,1,2,2],acoustic:[2,2,2,1,2,1,2],bartok:[2,2,2,1,2,1,2]};D.prototype._ST_SUM=12;D.prototype._RELATIVE_MAJOR_FULL_STEPS="1 b2/b9 2/9 b3/#9 3 4/11 b5/#11 5 #5/b13 6/13 b7/#13 7".split(" ");D.prototype._isArgReceived=function(a){return void 0!==a};D.prototype._getSemiTonesFromName=function(a){return this._ALL_SCALES[a]};D.prototype._isValidSemiTonesSum=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c];return b==this._ST_SUM?!0:!1};D.prototype.getDefaultName=function(){return"major"};
D.prototype.getDefaultSemiTones=function(){return[2,2,1,2,2,2,1]};D.prototype.isValidScaleName=function(a){if("string"!==typeof a)return this._IS_DEBUG&&console.error("Scale name must be a string"),!1;var b=this._getSemiTonesFromName(a);if(void 0!==b){if(this.isValidSemiTones(b))return!0;this._IS_DEBUG&&console.error("Invalid semitones for scale: "+a);return!1}this._IS_DEBUG&&console.error("Invalid scale Name: "+a);return!1};
D.prototype.isValidSemiTones=function(a){if("object"!==typeof a||!Array.isArray(a))return this._IS_DEBUG&&console.error("Semitones must be Array"),!1;if(this._isValidSemiTonesSum(a))return!0;this._IS_DEBUG&&console.error("Invalid semitones sum, must be: "+this._ST_SUM);return!1};D.prototype.setName=function(a){this.isValidScaleName(a)&&(this._name=a,this._semiTones=this._getSemiTonesFromName(a));return this};D.prototype.setRoot=function(a){this._root=new C(a);return this};D.prototype.getName=function(){return this._name};
D.prototype.getRoot=function(){return this._root};D.prototype.getSemiTones=function(){return this._semiTones.slice()};D.prototype.getNotes=function(){var a=[],b=this._root.getCopy();a.push(b);for(var c=0;c<this._semiTones.length;c++)b=b.higherST(this._semiTones[c],b.getName()),a.push(b);a.pop();return a};D.prototype.getNotesNames=function(){return this.getNotes().map(function(a){return a.getName()})};
D.prototype.getSemiTonesPatternForString=function(a){a=a.getCopy();for(var b=this.getSemiTones(),c=this.getNotesNames(),d=[],f=0,g=c.indexOf(a.getName());0>g;)a.higher(),g=c.indexOf(a.getName()),f++;d.push(f);for(a=g;a<b.length;a++)d.push(b[a]);for(a=0;a<g;a++)d.push(b[a]);return d};D.prototype.getRelativeMajorSteps=function(){for(var a=[this._RELATIVE_MAJOR_FULL_STEPS[0]],b=0,c=0;c<this._semiTones.length-1;c++)b+=this._semiTones[c],a.push(this._RELATIVE_MAJOR_FULL_STEPS[b]);return a};
D.prototype.serialize=function(){return[this._root,this._name]};D.prototype.deserialize=function(a){a&&(this.setRoot(a[0]),this.setName(a[1]));return this};D.prototype.toJSON=D.prototype.serialize;D.prototype.toString=function(){return this._name+" "+this.getNotesNames().join()};function E(a){this._name=this.getDefaultName();this._stringsTuning=this.getDefaultTunings();this._HS=0;this._isArgReceived(a)&&this.setName(a)}E.prototype._IS_DEBUG=!0;E.prototype._TUNINGS={standard_e:"E B G D A E B F# C# G# D# A#".split(" "),standard_e_bass:["G","D","A","E","B"],standard_e_bass_6:"CGDAEB".split(""),drop_d_6:"E B G D A D B F# C# G# D# A#".split(" "),drop_a_7:"E B G D A E A F# C# G# D# A#".split(" "),drop_e_8:"E B G D A E B E C# G# D# A#".split(" ")};E.prototype._CUSTOM_NAME="custom";
E.prototype._MIN_HS=-12;E.prototype._MAX_HS=12;E.prototype._isArgReceived=function(a){return void 0!==a};E.prototype._isValidTuningName=function(a){return this._TUNINGS.hasOwnProperty(a)};E.prototype._isValidStringsTuning=function(a){return a.every(function(a){return a instanceof C})};E.prototype._isValidHS=function(a){return Number.isInteger(a)&&a>=this._MIN_HS&&a<=this._MAX_HS};
E.prototype.isValidStringsTuning=function(a){if(this._isValidStringsTuning(a))return!0;this._IS_DEBUG&&console.error("Invalid strings tuning: "+a);return!1};E.prototype.isValidTuningName=function(a){if(this._isValidTuningName(a))return!0;this._IS_DEBUG&&console.error("Invalid strings tuning name: "+a);return!1};E.prototype.isInTunings=function(a){return this.getNameFromTunings(a)!==E._CUSTOM_NAME};
E.prototype.isValidHS=function(a){if(this._isValidHS(a))return!0;this._IS_DEBUG&&console.error("Invalid strings tuning half-steps number: "+a);return!1};E.prototype.getDefaultName=function(){return"standard_e"};E.prototype.getDefaultTunings=function(){return"E B G D A E B F# C# G# D# A#".split(" ").map(function(a){return new C(a)})};E.prototype.getStringTuning=function(a){return this._stringsTuning[a%this._stringsTuning.length].getCopy().higherST(this._HS)};
E.prototype.setStringTuning=function(a,b){b.higherST(-this._HS);if(a>=this._stringsTuning.length){for(var c=this._stringsTuning.length;c<a;c++)this._stringsTuning.push(this.getStringTuning(c));this._stringsTuning.push(b)}else this._stringsTuning[a]=b;this.isInTunings(this._stringsTuning)?this._name=this.getNameFromTunings(this._stringsTuning):this._name=this._CUSTOM_NAME;return this};
E.prototype.setName=function(a){this.isValidTuningName(a)&&(this._name=a,this._stringsTuning=this._TUNINGS[a].map(function(a){return new C(a)}));return this};E.prototype.getName=function(){return this._name};E.prototype.setTuning=function(a){this.isValidStringsTuning(a)&&(this._name=this.getNameFromTunings(a),this._stringsTuning=a);return this};E.prototype.setHS=function(a){this.isValidHS(a)&&(this._HS=a);return this};E.prototype.getHS=function(){return this._HS};
E.prototype.set=function(a,b,c){a===this._CUSTOM_NAME?(this._name=this._CUSTOM_NAME,this.setTuning(c)):this.setName(a);this._isArgReceived(b)&&this.setHS(b);return this};E.prototype.setFromArr=function(a){if(a)switch(a.length){case 1:this.set(a[0]);break;case 2:this.set(a[0],a[1]);break;case 3:this.set(a[0],a[1],a[2].map(function(a){return new C(a)}));break;default:this._IS_DEBUG&&console.error("Ivalid argument length: "+a)}return this};
E.prototype.getNameFromTunings=function(a){if(!this.isValidStringsTuning(a))return this._CUSTOM_NAME;for(var b in this._TUNINGS)if(this._TUNINGS[b].length==a.length&&this._TUNINGS[b].every(function(b,d){return b==a[d].getName()}))return b;return this._CUSTOM_NAME};E.prototype.incHS=function(){var a=this._HS;this.isValidHS(++a)&&(this._HS=a);return this};E.prototype.decHS=function(){var a=this._HS;this.isValidHS(--a)&&(this._HS=a);return this};
E.prototype.serialize=function(){var a=[this._name,this._HS];this._name===this._CUSTOM_NAME&&a.push(this._stringsTuning);return a};E.prototype.deserialize=E.prototype.setFromArr;E.prototype.toJSON=E.prototype.serialize;E.prototype.toString=function(){return this._name+" "+String(this._stringsTuning)+" Half-steps: "+this._HS};function G(a){0<a||(a=this._DEFAULT_SIZE);this._arr=Array(a);for(a=0;a<this._arr.length;a++)this._arr[a]=!0}G.prototype._IS_DEBUG=!0;G.prototype._DEFAULT_SIZE=12;G.prototype.set=function(a,b){a=Math.abs(a)%this._arr.length;isNaN(a)||(this._arr[a]=!!b);return this};G.prototype.get=function(a){a=Math.abs(a)%this._arr.length;return this._arr[a]};G.prototype.getArr=function(){return this._arr.slice()};G.prototype.getBinArr=function(){return this._arr.map(function(a){return+a})};
G.prototype.toInt=function(){var a=this.getBinArr();return parseInt(a.join(""),2)};G.prototype.fromInt=function(a){a=Math.abs(a);if(isNaN(a))return this._IS_DEBUG&&console.error("Invalid number"),this;a=a.toString(2).split("");if(a.length<this._arr.length)for(var b=this._arr.length-a.length,c=0;c<b;c++)a.unshift("0");else a=a.slice(a.length-this._arr.length);this._arr=a.map(function(a){return!!+a});return this};G.prototype.serialize=G.prototype.toInt;
G.prototype.deserialize=function(a){void 0!==a&&this.fromInt(a);return this};G.prototype.toJSON=G.prototype.serialize;G.prototype.toString=function(){return this.getBinArr().join("")};G.prototype.valueOf=G.prototype.toInt;var H={isCorrectStringsNumber:function(a){return Number.isInteger(a)&&3<=+a&&18>=+a},validateStringsNumber:function(a){return H.isCorrectStringsNumber(a)?a:6},isCorrectBoxFret:function(a){return Number.isInteger(a)&&-1<=a&&24>=a},validateBoxFret:function(a){return H.isCorrectBoxFret(a)?a:-1}};var I={init:function(){this.scales.init()}};I.scales={state:{},readFromStorage:function(){return window.localStorage.getItem("defaultScaleOptions")},saveToStorage:function(){window.localStorage.setItem("defaultScaleOptions",JSON.stringify(this.state))},init:function(){this.state=new J;this.state.deserialize(this.readFromStorage())}};function K(a){this.ctx=a;this.Q=[];this.handle=null;this.maxQlength=16}K.prototype.update=function(){if(0<this.Q.length){var a;do{var b=this.Q[0];var c=b.time;var d=c+b.duration;var f=this.getCurrentTime();var g=f>=c&&f<=d;(a=f<c)||g||this.Q.shift()}while(!g&&!a&&0<this.Q.length);if(g)switch(this.callBegin(b),c=this.getAnimationProgress(f,c,d),b.type){case "rotaton360cw":this.rotaton360cw(b.el,c);break;case "custom":b.anim(c)}}this.handle=requestAnimationFrame(this.update.bind(this))};
K.prototype.callBegin=function(a){a.begin&&!a.isBeginDone&&(a.isBeginDone=!0,a.begin())};K.prototype.rotaton360cw=function(a,b){this.setAngle(a,360*b)};K.prototype.getAnimationProgress=function(a,b,c){return(a-b)/(c-b)};K.prototype.getCurrentTime=function(){return this.ctx.currentTime};K.prototype.setAngle=function(a,b){a.style.transform="rotateZ("+b%360+"deg)"};K.prototype.push=function(a){this.Q.length<this.maxQlength&&this.Q.push(a)};K.prototype.clear=function(){this.Q=[]};
K.prototype.stop=function(){cancelAnimationFrame(this.handle);this.clear()};K.prototype.start=function(){this.handle=requestAnimationFrame(this.update.bind(this))};function L(a,b,c){this.metrState=a;this.ctx=b;this.worker=c;this.clickOscType="square";this.validOscTypes=["sine","square","sawtooth","triangle"];this.dummyNode={};this.rampNode={};this.gainNode={};this.eqNode={};this.init()}
L.prototype.scheduleBeat=function(a){var b=this.ctx.createOscillator();b.type=this.clickOscType;var c=739.99,d=this.secondClickDur;0==a.number&&(c=1108.73,d=this.firstClickDur);d>a.maxDur&&(d=this.getDurationForFreq(c,a.maxDur));b.frequency.value=c;b.connect(this.dummyNode);b.start(a.audioTime);b.stop(a.audioTime+d);this.rampAudio(a.audioTime,d);b.onended=function(){b.disconnect()}};L.prototype.getDurationForFreq=function(a,b){a=1/a;return Math.floor(b/a)*a};
L.prototype.rampAudio=function(a,b){var c=.05*b;this.rampNode.gain.setTargetAtTime(0,a+c,this.getTimeConstForClick(c));this.rampNode.gain.setTargetAtTime(1,a+(b+.25*b),Number.MIN_VALUE)};L.prototype.getTimeConstForClick=function(a){var b=3*a;.002>a&&(b=1.5*a);.0015>a&&(b*=1.5);.001>a&&(b*=1.5);return b};L.prototype.setClickType=function(a){-1!==this.validOscTypes.indexOf(a)&&(this.clickOscType=a)};L.prototype.getTime=function(){return this.ctx.currentTime};
L.prototype.updateVolume=function(){var a=this.gainNode.gain,b=this.metrState.volume,c=0;0<b&&(c=Math.log(1),c=Math.exp(c+(Math.log(100)-c)/100*(b-0)));a.value=c/100};L.prototype.clearAudioQ=function(){this.rampNode.disconnect();this.dummyNode.disconnect();this.rampNode={};this.dummyNode={};this.initRampNode();this.initDummyNode()};L.prototype.initRampNode=function(){this.rampNode=this.ctx.createGain();this.rampNode.connect(this.gainNode)};
L.prototype.initGainNode=function(){this.gainNode=this.ctx.createGain();this.updateVolume();this.gainNode.connect(this.eqNode)};L.prototype.initEqNode=function(){this.eqNode=this.ctx.createBiquadFilter();this.eqNode.type="lowpass";this.eqNode.frequency.value=4E3;this.eqNode.connect(this.ctx.destination)};L.prototype.initDummyNode=function(){this.dummyNode=this.ctx.createGain();this.dummyNode.connect(this.rampNode)};
L.prototype.init=function(){this.initEqNode();this.initGainNode();this.initRampNode();this.initDummyNode();this.firstClickDur=this.getDurationForFreq(1108.73,.05);this.secondClickDur=this.getDurationForFreq(739.99,.05)};function M(a,b){this.$beatVisBlock=b;this.animationQ=new K(a);this.cnv=this.$beatVisBlock[0];this.ctx=this.cnv.getContext("2d");this.beatNumber=0;this.scaleCoeff=2;this.init()}M.prototype.scheduleBeatVisual=function(a,b){var c=0==a.number;b={anim:this.animate.bind(this),type:"custom",time:a.audioTime,duration:b};b.begin=function(){this.$beatVisBlock.toggleClass("metronome_first_beat_number_vis",c);this.setStrokeColor();this.beatNumber=a.number}.bind(this);this.animationQ.push(b)};
M.prototype.animate=function(a){a*=2*Math.PI;this.clearCnv();this.drawArc(a);this.drawBeatNumber()};M.prototype.clearCnv=function(){this.ctx.save();this.ctx.setTransform(1,0,0,1,0,0);this.ctx.clearRect(0,0,this.cnv.width,this.cnv.height);this.ctx.restore()};
M.prototype.drawArc=function(a){this.ctx.lineWidth=6*this.scaleCoeff;this.ctx.strokeStyle=this.strokeColor;this.ctx.beginPath();var b=.5*this.cnv.width,c=.5*this.cnv.height,d=.5*Math.PI;this.ctx.arc(b,c,Math.min(b,c)-.5*this.ctx.lineWidth,0-d,a-d);this.ctx.stroke()};M.prototype.drawBeatNumber=function(){this.ctx.fillStyle=this.strokeColor;var a=.5*this.cnv.width,b=.5*this.cnv.height+.37*parseInt(this.fontSize);this.ctx.fillText(this.beatNumber+1,a,b)};
M.prototype.setStrokeColor=function(){this.strokeColor=this.$beatVisBlock.css("color")};M.prototype.stop=function(){this.animationQ.stop();this.clearCnv()};M.prototype.play=function(){this.animationQ.start()};M.prototype.initFont=function(){this.fontFamily=this.$beatVisBlock.css("font-family");this.fontSize=parseInt(this.$beatVisBlock.css("font-size"))*this.scaleCoeff+"px";this.ctx.font=this.fontSize+" "+this.fontFamily;this.ctx.textAlign="center"};
M.prototype.initCanvasScale=function(){var a=+this.$beatVisBlock.attr("width")*this.scaleCoeff,b=+this.$beatVisBlock.attr("height")*this.scaleCoeff;this.$beatVisBlock.attr("width",a);this.$beatVisBlock.attr("height",b)};M.prototype.init=function(){this.initCanvasScale();this.initFont()};function N(a,b,c){this.metrState=a;this.audioCtx=b;this.worker=c;this.msgEnum=msgActionEnum.metr;this.Q=[];this.nextBeatNumber=0;this.lookAheadNumber=1;this.init()}N.prototype.scheduleBeats=function(){for(;1<this.Q.length;){var a=this.Q.shift();this.audio.scheduleBeat(a);this.metrAnimation.scheduleBeatVisual(a,this.getDurBetweenBeats())}};
N.prototype.addBeatsToQ=function(a){var b=this.getDurBetweenBeats(),c=this.Q[this.Q.length-1].audioTime;if(this.audio.getTime()+b*a>=c){for(var d=this.Q.length;d<a;d++)this.nextBeatNumber=(this.nextBeatNumber+1)%this.metrState.beats,c=new O(c+b,this.nextBeatNumber,b/2),this.Q.push(c),c=this.Q[this.Q.length-1].audioTime;this.scheduleBeats()}};
N.prototype.beatsSchedulerTick=function(){if(0<this.Q.length){var a=Math.ceil(1/this.ticksPerSecond*2/this.getDurBetweenBeats())+1;this.lookAheadNumber=a;this.addBeatsToQ(a)}else a=new O(this.audio.getTime(),this.nextBeatNumber,this.getDurBetweenBeats()/2),this.Q.push(a)};N.prototype.beatsSchedulerStart=function(){this.clearQ();this.nextBeatNumber=0};N.prototype.clearQ=function(){this.Q=[]};N.prototype.getDurBetweenBeats=function(){return 240/this.metrState.beatValue/this.metrState.tempo};
N.prototype.onRateChange=function(){this.metrState.isPlaying&&(this.audio.clearAudioQ(),.5<this.getDurBetweenBeats()*this.lookAheadNumber&&(this.clearQ(),this.metrAnimation.animationQ.clear()))};N.prototype.getWorkerTickrate=function(){var a=new workerMsg(this.msgEnum.getTickrate);this.worker.postMessage(a)};N.prototype.onWorkerMessage=function(a){var b=a.data.data;switch(a.data.action){case this.msgEnum.tick:this.beatsSchedulerTick();break;case this.msgEnum.tickrate:this.ticksPerSecond=b}};
N.prototype.updateVolume=function(){this.audio.updateVolume()};N.prototype.start=function(){this.beatsSchedulerStart();this.metrAnimation.play();var a=new workerMsg(this.msgEnum.startTicking);this.worker.postMessage(a)};N.prototype.stop=function(){this.audio.clearAudioQ();this.metrAnimation.stop();var a=new workerMsg(this.msgEnum.stopTicking);this.worker.postMessage(a)};
N.prototype.init=function(){this.audio=new L(this.metrState,this.audioCtx,this.worker);this.audio.updateVolume(this.metrState.volume);this.metrAnimation=new M(this.audioCtx,$("#metronome_pointer_block"));this.worker.onmessage=this.onWorkerMessage.bind(this);this.getWorkerTickrate()};var P,Q,R=!1;try{P=new AudioContext,Q=new Worker("js/worker_metr.js"),R=!0}catch(a){console.error(a)}function O(a,b,c){this.audioTime=a;this.number=b;this.maxDur=c}
var ba={audioCtx:P,worker:Q,state:{isPlaying:!1,volume:50,beats:4,beatValue:4,tempo:120},$playBtn:$("#metronome_play_btn"),$stopBtn:$("#metronome_stop_btn"),$clickTypeSelect:$("#metronome_click_type_select"),$volumeRange:$("#metronome_volume_range"),$tempoRange:$("#metronome_tempo_range"),$tempoOptionsBlock:$("#tempos"),$tempoInput:$("#metronome_tempo_input"),$tempoLeftArrow:$("#metronome_tempo_left_arrow"),$tempoRightArrow:$("#metronome_tempo_right_arrow"),$beatsSelect:$("#metronome_beats_select"),
$beatsLeftArrow:$("#metronome_beats_left_arrow"),$beatsRightArrow:$("#metronome_beats_right_arrow"),$beatValSelect:$("#metronome_beat_val_select"),$beatValLeftArrow:$("#metronome_beat_val_left_arrow"),$beatValRightArrow:$("#metronome_beat_val_right_arrow"),initTempoOptionsDatalist:function(){for(var a=40;320>=a;a+=5)$(k({tempo:a})).appendTo(this.$tempoOptionsBlock)},onPlayBtn:function(a){that=a.data.that;that.state.isPlaying||(that.state.isPlaying=!0,$(this).hide(),that.$stopBtn.show(),that.scheduler.start())},
onStopBtn:function(a){that=a.data.that;that.state.isPlaying&&(that.state.isPlaying=!1,$(this).hide(),that.$playBtn.show(),that.scheduler.stop())},onClickTypeChange:function(a){that=a.data.that;that.scheduler.audio.setClickType($(this).val())},onVolumeChange:function(a){that=a.data.that;a=$(this).val();that.state.volume=a;that.scheduler.updateVolume()},onTempoChange:function(a){that=a.data.that;a=$(this).val();that.$tempoInput.val(a);that.state.tempo=+a;that.scheduler.onRateChange()},onTempoInputChange:function(a){that=
a.data.that;a=$(this).val().replace(/[^,.0-9]/gim,"").replace(/[,.]+/gim,".");a=parseFloat(a);40>a?a=40:320<a&&(a=320);that.state.tempo=a;$(this).val(a);that.$tempoRange.val(a);that.scheduler.onRateChange()},onTempoLeftArrow:function(a){that=a.data.that;a=that.$tempoInput.val();40<a&&(a--,that.state.tempo=a,that.$tempoInput.val(a),that.$tempoRange.val(a),that.scheduler.onRateChange())},onTempoRightArrow:function(a){that=a.data.that;a=that.$tempoInput.val();320>a&&(a++,that.state.tempo=a,that.$tempoInput.val(a),
that.$tempoRange.val(a),that.scheduler.onRateChange())},onBeatsChange:function(a){that=a.data.that;a=$(this).val();that.state.beats=+a},onBeatsLeftArrow:function(a){that=a.data.that;a=that.state.beats;1>=a||(a--,that.state.beats=a,that.$beatsSelect.val(a))},onBeatsRightArrow:function(a){that=a.data.that;a=that.state.beats;16<=a||(a++,that.state.beats=a,that.$beatsSelect.val(a))},onBeatValChange:function(a){that=a.data.that;a=$(this).val();that.state.beatValue=+a;that.scheduler.onRateChange()},onBeatValLeftArrow:function(a){that=
a.data.that;a=that.state.beatValue;1>=a||(a/=2,that.state.beatValue=a,that.$beatValSelect.val(a),that.scheduler.onRateChange())},onBeatValRightArrow:function(a){that=a.data.that;a=that.state.beatValue;32<=a||(a*=2,that.state.beatValue=a,that.$beatValSelect.val(a),that.scheduler.onRateChange())},initUI:function(){this.state.tempo=this.$tempoRange.val();this.state.volume=this.$volumeRange.val();this.state.tempo=this.$tempoRange.val();this.$tempoInput.val(this.state.tempo);this.state.beats=this.$beatsSelect.val();
this.state.beatValue=this.$beatValSelect.val();this.scheduler.audio.setClickType(this.$clickTypeSelect.val())},init:function(){this.$stopBtn.hide();R&&($("#metronome_disabled_block").hide(0),this.initTempoOptionsDatalist(),this.scheduler=new N(this.state,this.audioCtx,this.worker),this.initUI(),this.$playBtn.click({that:this},this.onPlayBtn),this.$stopBtn.click({that:this},this.onStopBtn),this.$clickTypeSelect.change({that:this},this.onClickTypeChange),this.$volumeRange.change({that:this},this.onVolumeChange),
this.$volumeRange.on("input",{that:this},this.onVolumeChange),this.$tempoRange.change({that:this},this.onTempoChange),this.$tempoRange.on("input",{that:this},this.onTempoChange),this.$tempoInput.change({that:this},this.onTempoInputChange),this.$tempoLeftArrow.click({that:this},this.onTempoLeftArrow),this.$tempoRightArrow.click({that:this},this.onTempoRightArrow),this.$beatsSelect.change({that:this},this.onBeatsChange),this.$beatsLeftArrow.click({that:this},this.onBeatsLeftArrow),this.$beatsRightArrow.click({that:this},
this.onBeatsRightArrow),this.$beatValSelect.change({that:this},this.onBeatValChange),this.$beatValLeftArrow.click({that:this},this.onBeatValLeftArrow),this.$beatValRightArrow.click({that:this},this.onBeatValRightArrow))}};var S=!1,ca={$openBtn:$("#common_settings_btn"),$closeBtn:$("#settings_close_btn"),$settingsBlock:$("#settings_block"),isShown:!1,colorSchemeSwitcher:new function(){function a(){h.forEach(function(a){b.toggleClass(a,!1)})}var b=$(".bg_block"),c={day:$("#color_scheme_switch_day_btn"),night:$("#color_scheme_switch_night_btn")},d="night";this.saveToStorage=function(){window.localStorage.setItem("colorScheme",d)};this.switchScheme=function(c){0<=h.indexOf(c)&&(d=c,a(),b.toggleClass(d,!0),this.saveToStorage())};
this.onSwitchToDayColorBtn=function(a){a=a.data.that;$(this).hide();c.night.show();a.switchScheme("day")};this.onSwitchToNightColorBtn=function(a){a=a.data.that;$(this).hide();c.day.show();a.switchScheme("night")};this.initButtons=function(){"day"==d?c.day.hide():c.night.hide();c.day.click({that:this},this.onSwitchToDayColorBtn);c.night.click({that:this},this.onSwitchToNightColorBtn)};this.init=function(){var a=window.localStorage.getItem("colorScheme");a&&(d=a);this.switchScheme(d);this.initButtons()}},
notationSwitcher:new function(){var a=$("#to_flat_notation_btn"),b=$("#to_sharp_notation_btn"),c=!1;this.toFlat=function(){S=c=!0;a.hide();b.show();T.updateNoteNotation()};this.toSharp=function(){S=c=!1;b.hide();a.show()};this.saveToStorage=function(){window.localStorage.setItem("isFlatNotation",(+!!c).toString())};this.onToFlatClick=function(a){a=a.data.that;a.toFlat();a.saveToStorage();T.updateNoteNotation()};this.onToSharpClick=function(a){a=a.data.that;a.toSharp();a.saveToStorage();T.updateNoteNotation()};
this.initButtons=function(){c?(a.hide(),b.show()):(a.show(),b.hide());a.click({that:this},this.onToFlatClick);b.click({that:this},this.onToSharpClick)};this.init=function(){c=!!+window.localStorage.getItem("isFlatNotation");this.initButtons();c?this.toFlat():this.toSharp();T.updateNoteNotation()}},showMenuToggle:function(a){a?this.$settingsBlock.slideDown(100):this.$settingsBlock.slideUp(100)},onOpenBtnClick:function(a){a=a.data.that;a.isShown=!a.isShown;a.showMenuToggle(a.isShown)},onCloseBtnClick:function(a){a=
a.data.that;a.isShown=!1;a.showMenuToggle(a.isShown)},init:function(){this.$settingsBlock.toggleClass("settings_block_hide",!1);this.$settingsBlock.hide();this.$openBtn.click({that:this},this.onOpenBtnClick);this.$closeBtn.click({that:this},this.onCloseBtnClick);this.$settingsBlock.parent().on("clickoutside",{that:this},this.onCloseBtnClick);this.colorSchemeSwitcher.init();this.notationSwitcher.init()}};function U(a,b){this.init(a,b)}U.prototype.deleteItem=function(){var a=$(this);T.deleteItem(a.attr("id"));a.remove()};U.prototype.onItemTypeChange=function(){$(this).val().toLowerCase()};U.prototype.onCloseButton=function(a){a=a.data.that;a.$itemBlock.slideUp(200,a.deleteItem)};U.prototype.onSetDefaultButton=function(a){a.data.that.item.state.saveToDefaultOptions()};U.prototype.initAnimation=function(){this.$itemBlock.hide();this.$itemBlock.slideDown(200)};U.prototype.updateNoteNotation=function(){this.item.updateNoteNotation()};
U.prototype.init=function(a,b){T.$addNewItemBtn.before(l({id:a}));this.$itemBlock=$("#"+a);this.item=itemsFactory.getItem(a,b);this.initAnimation();$(".item_head_select",this.$itemBlock).change({that:this},this.onItemTypeChange);$(".close_btn",this.$itemBlock).click({that:this},this.onCloseButton);$(".set_default_btn",this.$itemBlock).click({that:this},this.onSetDefaultButton)};function V(a,b,c){this.state=a;this.$stringsTuningBlock=b;this.tuneBlocks=[];this.tuneChangeEventAction=c;this.init()}V.prototype.addStringTuning=function(a){var b=$(aa()).appendTo(this.$stringsTuningBlock);$(".string_tune_select",b).val(a.getName());$(".string_tune_select",b).change({that:this},this.onStringTuneChange);$(".left_arrow",b).click({that:this},this.onLeftArrowTuneClick);$(".right_arrow",b).click({that:this},this.onRightArrowTuneClick);this.updateTuneNoteNotation(b);this.tuneBlocks.push(b)};
V.prototype.delLastString=function(){this.tuneBlocks.pop().remove()};V.prototype.selectCurrentStringsTunes=function(){for(var a=0;a<this.tuneBlocks.length;a++){var b=this.state.tuning.getStringTuning(a).getName();this.tuneBlocks[a].find(".string_tune_select").val(b)}};V.prototype.onStringTuneChange=function(a){a=a.data.that;var b=$(this).val(),c=$(".string_tune_select",a.$stringsTuningBlock).index(this);a.state.tuning.setStringTuning(c,new C(b));a.tuneChangeEventAction(c);a.state.saveToQuery()};
V.prototype.onLeftArrowTuneClick=function(a){a=a.data.that;var b=$(".left_arrow",a.$stringsTuningBlock).index(this),c=a.state.tuning.getStringTuning(b);a.state.tuning.setStringTuning(b,c.lower());a.tuneBlocks[b].find(".string_tune_select",a.$stringsTuningBlock).val(c.getName());a.tuneChangeEventAction(b);a.state.saveToQuery()};
V.prototype.onRightArrowTuneClick=function(a){a=a.data.that;var b=$(".right_arrow",a.$stringsTuningBlock).index(this),c=a.state.tuning.getStringTuning(b);a.state.tuning.setStringTuning(b,c.higher());a.tuneBlocks[b].find(".string_tune_select").val(c.getName());a.tuneChangeEventAction(b);a.state.saveToQuery()};V.prototype.updateTuneNoteNotation=function(a){a.find(".string_tune_select option").each(function(){var a=$(this),c=a.val();S&&(c=(new C(c)).normalSharpToFlat());a.text(c)})};
V.prototype.updateNoteNotation=function(){for(var a=0;a<this.tuneBlocks.length;a++)this.updateTuneNoteNotation(this.tuneBlocks[a])};V.prototype.init=function(){for(var a=0;a<this.state.stringsNumber;a++)this.addStringTuning(this.state.tuning.getStringTuning(a));this.selectCurrentStringsTunes()};function W(a,b){this.state=a;this.$fretboardBlock=b;this.notesBlocks=[];this.verFrets=[];this.init()}
W.prototype.putNote=function(a,b,c,d){c=$(this.notesBlocks[c][b]);c.toggleClass("hidden_note",!1);var f=this.state.scale.getNotesNames().indexOf(a);d=-1==this.state.boxFirstFret||b>=this.state.boxFirstFret&&b<this.state.boxFirstFret+d;this.state.isTriadMode?(b=!this.state.triadsNotesShowPattern.get(f),c.text(f+1)):(b=!this.state.normalNotesShowPattern.get(f),f=a,S&&(f=(new C(a)).normalSharpToFlat()),c.text(f));!b&&d||c.toggleClass("transparent_note",!0);a=a==this.state.scale.getRoot().getName();c.toggleClass("normal_note",
!a).toggleClass("highlighted_note",a)};W.prototype.putNotesOnString=function(a){var b=this.calculateNotesBoxSize(a,this.state.boxFirstFret),c=this.state.tuning.getStringTuning(a),d=this.state.scale.getSemiTonesPatternForString(c),f=$(this.notesBlocks[a]);f.toggleClass("hidden_note",!0);f.toggleClass("transparent_note",!1);var g=d.shift();c=c.higherST(g);for(var B=0;g<f.length;)this.putNote(c.getName(),g,a,b),g+=d[B],c.higherST(d[B]),B=++B%d.length};
W.prototype.putNotesOnAllStrings=function(){for(var a=0;a<this.state.stringsNumber;a++)this.putNotesOnString(a)};W.prototype.putNotesOnNearStrings=function(a){var b=a-1;a+=1;0<=b&&this.putNotesOnString(b);a<this.state.stringsNumber&&this.putNotesOnString(a)};
W.prototype.calculateNotesBoxSize=function(a,b){var c=0;if(0<a){var d=this.state.tuning.getStringTuning(a-1);a=this.state.tuning.getStringTuning(a);d.higherST(b);a.higherST(b);if(a.getName()==d.getName())return 1;for(;a.getName()!=d.getName();)a.higher(),a!=d&&c++}else c=4;return c};W.prototype.calculateNotesBoxSizeForAllStrings=function(a){for(var b=0,c=this.state.stringsNumber-1;0<=c;c--){var d=this.calculateNotesBoxSize(c,a);d>b&&(b=d)}return b};
W.prototype.isBoxFit=function(a,b){return 24>=a+b};W.prototype.addString=function(a){for(var b={currentStringNumber:Math.min(a+1,12)},c=this.verFrets,d,f,g=0;g<c.length;g++)d=$(w(b)).appendTo(c[g]),d=$(".note",d)[0],void 0===this.notesBlocks[a]&&(this.notesBlocks[a]=[]),this.notesBlocks[a][g]=d,0==a&&(d=1==g||3==g||5==g||7==g||9==g||15==g||17==g||19==g||21==g,f=12==g||24==g,d?($(c[g]).append(x()),$(z()).insertAfter(c[g])):f&&($(c[g]).append(y()),$(A()).insertAfter(c[g])));this.putNotesOnString(a)};
W.prototype.delLastString=function(){for(var a=0;a<this.verFrets.length;a++)$(".fret_hor",$(this.verFrets[a])).last().remove()};W.prototype.onFretClick=function(a){a=a.data.that;var b=a.$fretboardBlock.find(".fret_null, .fret_ver_inner").index(this);if(a.state.boxFirstFret==b)a.state.boxFirstFret=-1;else{var c=a.calculateNotesBoxSizeForAllStrings(b);a.isBoxFit(b,c)&&(a.state.boxFirstFret=b)}a.putNotesOnAllStrings();a.state.saveToQuery()};
W.prototype.onFretHoverIn=function(a){var b=a.data.that;a=b.$fretboardBlock.find(".fret_null, .fret_ver_inner").index(this);var c=b.calculateNotesBoxSizeForAllStrings(a);if(b.isBoxFit(a,c)){b=$(".fret_ver_hover",b.$fretboardBlock);for(var d=0;d<c;d++){var f="fret_ver_hover_active_center";0==d?f="fret_ver_hover_active_start":d==c-1&&(f="fret_ver_hover_active_end");$(b[a+d]).toggleClass(f,!0)}}};
W.prototype.onFretHoverOut=function(a){a.data.that.$fretboardBlock.find(".fret_ver_hover").toggleClass("fret_ver_hover_active_start",!1).toggleClass("fret_ver_hover_active_center",!1).toggleClass("fret_ver_hover_active_end",!1)};W.prototype.updateNoteNotation=W.prototype.putNotesOnAllStrings;
W.prototype.init=function(){for(var a=0;24>a;a++)this.$fretboardBlock.children().last().before(v());this.verFrets=$(".fret_null, .fret_ver_inner",this.$fretboardBlock);for(a=0;a<this.state.stringsNumber;a++)this.addString(a);this.$fretboardBlock.on("click",".fret_null, .fret_ver_inner",{that:this},this.onFretClick);this.$fretboardBlock.on("mouseenter",".fret_null, .fret_ver_inner",{that:this},this.onFretHoverIn);this.$fretboardBlock.on("mouseleave",".fret_null, .fret_ver_inner",{that:this},this.onFretHoverOut)};function X(a,b,c,d,f,g,B){this.state=a;this.$neckBlock=b;this.$stringsNumberBlock=c;this.$addStringBtn=d;this.$delStringBtn=f;this.$tuningOptionsBlock=g;this.$lhToggleBlock=B;var F=this;this.fretboard=new W(a,$(".fretboard",b));this.stringsTunings=new V(a,$(".strings_options_block",b),function(a){F.putNotesOnString(a);F.fretboard.putNotesOnNearStrings(a);F.selectCurrentTuning()});this.init()}X.prototype.putNotesOnString=function(a){this.fretboard.putNotesOnString(a)};
X.prototype.putNotesOnAllStrings=function(){this.fretboard.putNotesOnAllStrings()};X.prototype.selectCurrentStringsTunes=function(){this.stringsTunings.selectCurrentStringsTunes()};X.prototype.selectCurrentTuning=function(){this.$tuningOptionsBlock.find(".tuning_select").val(this.state.tuning.getName())};
X.prototype.switchLH=function(){this.$lhToggleBlock.find(".toggle_checkbox_slider").toggleClass("slider_lh",this.state.isLH).toggleClass("slider_rh",!this.state.isLH);this.$neckBlock.toggleClass("lh",this.state.isLH)};X.prototype.switchLHevent=function(){this.state.isLH=!this.state.isLH;this.switchLH();this.state.saveToQuery()};X.prototype.onTuningChange=function(a){a=a.data.that;var b=$(this).val().toLowerCase();a.state.tuning.setName(b);a.putNotesOnAllStrings();a.selectCurrentStringsTunes();a.state.saveToQuery()};
X.prototype.selectCurrentHalfStep=function(){$(".half_step_select",this.$tuningOptionsBlock).val(this.state.tuning.getHS())};X.prototype.onHalfStepChange=function(a){a=a.data.that;newValue=+$(this).val();a.state.tuning.setHS(newValue);a.selectCurrentStringsTunes();a.putNotesOnAllStrings();a.state.saveToQuery()};X.prototype.onLeftArrowHalfStepClick=function(a){a=a.data.that;a.state.tuning.decHS();a.selectCurrentStringsTunes();a.putNotesOnAllStrings();a.selectCurrentHalfStep();a.state.saveToQuery()};
X.prototype.onRightArrowHalfStepCLick=function(a){a=a.data.that;a.state.tuning.incHS();a.selectCurrentStringsTunes();a.putNotesOnAllStrings();a.selectCurrentHalfStep();a.state.saveToQuery()};X.prototype.onAddStringButton=function(a){a=a.data.that;if(18>a.state.stringsNumber){a.fretboard.addString(a.state.stringsNumber);var b=a.state.tuning.getStringTuning(a.state.stringsNumber);a.stringsTunings.addStringTuning(b);a.state.stringsNumber++;a.$stringsNumberBlock.text(""+a.state.stringsNumber);a.state.saveToQuery()}};
X.prototype.onDelStringButton=function(a){a=a.data.that;3<a.state.stringsNumber&&(a.fretboard.delLastString(),a.stringsTunings.delLastString(),a.state.stringsNumber--,a.$stringsNumberBlock.text(""+a.state.stringsNumber),a.state.saveToQuery())};X.prototype.onLhToggleSlider=function(a){a.data.that.switchLHevent()};X.prototype.onLhToggleClick=function(a){a=a.data.that;a.state.isLH||a.switchLHevent()};X.prototype.onRhToggleClick=function(a){a=a.data.that;a.state.isLH&&a.switchLHevent()};
X.prototype.updateNoteNotation=function(){this.fretboard.updateNoteNotation();this.stringsTunings.updateNoteNotation()};
X.prototype.init=function(){this.$stringsNumberBlock.text(""+this.state.stringsNumber);this.selectCurrentTuning();this.selectCurrentHalfStep();this.putNotesOnAllStrings();this.switchLH();this.$addStringBtn.click({that:this},this.onAddStringButton);this.$delStringBtn.click({that:this},this.onDelStringButton);$(".tuning_select",this.$tuningOptionsBlock).change({that:this},this.onTuningChange);$(".half_step_select",this.$tuningOptionsBlock).change({that:this},this.onHalfStepChange);this.$tuningOptionsBlock.find(".half_step_block").find(".left_arrow").click({that:this},
this.onLeftArrowHalfStepClick);this.$tuningOptionsBlock.find(".half_step_block").find(".right_arrow").click({that:this},this.onRightArrowHalfStepCLick);this.$lhToggleBlock.find(".toggle_checkbox").click({that:this},this.onLhToggleSlider);this.$lhToggleBlock.find(".lh_toggle").click({that:this},this.onLhToggleClick);this.$lhToggleBlock.find(".rh_toggle").click({that:this},this.onRhToggleClick)};function J(){this.type="scales";this.scale=new D;this.tuning=new E;this.stringsNumber=6;this.isTriadMode=!1;this.normalNotesShowPattern=new G(12);this.triadsNotesShowPattern=(new G(12)).deserialize(2688);this.boxFirstFret=-1;this.isLH=!1}J.prototype.toArr=function(){return[this.type,this.scale,this.tuning,+this.stringsNumber,+this.isTriadMode,this.normalNotesShowPattern,this.triadsNotesShowPattern,this.boxFirstFret,+this.isLH]};J.prototype.serialize=function(){return JSON.stringify(this.toArr())};
J.prototype.toJSON=J.prototype.toArr;J.prototype.deserialize=function(a){var b=[];if(a)try{b=JSON.parse(a)}catch(c){console.error("Invalid JSON: "+a)}this.scale=(new D).deserialize(b[1]);this.tuning=(new E).deserialize(b[2]);this.stringsNumber=H.validateStringsNumber(b[3]);this.isTriadMode=!!b[4];this.normalNotesShowPattern.deserialize(b[5]);this.triadsNotesShowPattern.deserialize(b[6]);this.boxFirstFret=H.validateBoxFret(b[7]);this.isLH=!!b[8]};
function Y(a,b){J.call(this);this.id=a;this.init(b)}Y.prototype=Object.create(J.prototype);Y.prototype.saveToQuery=function(){T.updateItemSerializedData(this.id,this.serialize());T.updateItemsQueryParams()};Y.prototype.saveToDefaultOptions=function(){I.scales.state.deserialize(this.serialize());I.scales.saveToStorage()};Y.prototype.readFromDefaultOptions=function(){this.deserialize(I.scales.state.serialize())};Y.prototype.init=function(a){this.readFromDefaultOptions();a&&this.deserialize(a);this.saveToQuery()};function Z(a,b){this.state=new Y(a,b);this.$itemBlock=$("#"+a);this.init()}Z.prototype.putNotesOnAllStrings=function(){this.neck.putNotesOnAllStrings()};Z.prototype.selectCurrentStringsTunes=function(){this.neck.selectCurrentStringsTunes()};Z.prototype.selectCurrentScale=function(){$(".scale_select [value='"+this.state.scale.getName()+"']",this.$itemBlock).prop("selected",!0)};
Z.prototype.updateScaleNotesBlock=function(){$(".scale_notes",this.$itemBlock).remove();var a=this.state.scale.getNotes(),b=this.state.scale.getRoot();a.push(b);a=S?a.map(function(a){return a.normalSharpToFlat()}):a.map(function(a){return a.get()});b=this.state.scale.getRelativeMajorSteps();b.push(b[0]);a={root:a[0],semiTones:this.state.scale.getSemiTones(),relativeSteps:b,notes:a};$(".scale_notes_and_semitones_block",this.$itemBlock).append(u(a));a=$(".scale_notes",this.$itemBlock).find(".scale_note_text");
b=a.length-1;var c=this.state.normalNotesShowPattern.getArr();this.state.isTriadMode&&(c=this.state.triadsNotesShowPattern.getArr());for(var d=0;d<b;d++)if(!c[d]){var f=$(a[d]);f.toggleClass("transparent_block",!0);0==d&&(f=$(a[b]),f.toggleClass("transparent_block",!0))}$(".scale_notes",this.$itemBlock).on("click",".scale_note",{that:this},this.onScaleNoteClick)};
Z.prototype.selectCurrentRootNote=function(){$(".root_note.selected_text",this.$itemBlock).toggleClass("selected_text",!1);var a=this.state.scale.getRoot().getName();S&&(a=(new C(a)).normalSharpToFlat());$(".root_note:contains('"+a+"')",this.$itemBlock).first().toggleClass("selected_text",!0)};Z.prototype.onScaleChange=function(a){a=a.data.that;var b=$(this).val().toLowerCase();a.state.scale.setName(b);a.putNotesOnAllStrings();a.updateScaleNotesBlock();a.state.saveToQuery()};
Z.prototype.onRootNoteChange=function(a){a=a.data.that;var b=$(this).text();a.state.scale.setRoot(b);a.selectCurrentRootNote();a.updateScaleNotesBlock();a.putNotesOnAllStrings();a.state.saveToQuery()};
Z.prototype.onScaleNoteClick=function(a){a=a.data.that;var b=$(".scale_note",a.$itemBlock).index(this);b%=a.state.scale.getNotes().length;if(a.state.isTriadMode){var c=!a.state.triadsNotesShowPattern.get(b);a.state.triadsNotesShowPattern.set(b,c)}else c=!a.state.normalNotesShowPattern.get(b),a.state.normalNotesShowPattern.set(b,c);0==b?(b=$(".scale_note",a.$itemBlock).last().find(".scale_note_text"),b.toggleClass("transparent_block",!c),b=$(".scale_note",a.$itemBlock).first().find(".scale_note_text")):
b=$(this).find(".scale_note_text");b.toggleClass("transparent_block",!c);a.putNotesOnAllStrings();a.state.saveToQuery()};Z.prototype.onTriadsCheckboxClick=function(a){a=a.data.that;a.state.isTriadMode?(a.state.isTriadMode=!1,a.$triadsCheckbox.hide(),a.$triadsCheckboxEmpty.show()):(a.state.isTriadMode=!0,a.$triadsCheckboxEmpty.hide(),a.$triadsCheckbox.show());a.updateScaleNotesBlock();a.putNotesOnAllStrings();a.state.saveToQuery()};
Z.prototype.initTriadsCheckbox=function(){this.$triadsCheckbox=$(".triads_checkbox",this.$itemBlock);this.$triadsCheckboxEmpty=$(".triads_checkbox_empty",this.$itemBlock);this.state.isTriadMode?this.$triadsCheckboxEmpty.hide():this.$triadsCheckbox.hide();this.$triadsCheckbox.click({that:this},this.onTriadsCheckboxClick);this.$triadsCheckboxEmpty.click({that:this},this.onTriadsCheckboxClick)};
Z.prototype.initDOM=function(){this.$itemOptionsBlock=$(".item_options_block",this.$itemBlock);this.$stringsBtnsBlock=$(m()).insertBefore($(".item_head_select",this.$itemBlock));this.$lhToggleBlock=$(n()).insertAfter($(".item_head_select",this.$itemBlock));this.$neckBlock=$(p()).insertAfter($(".item_head",this.$itemBlock));this.$scalesOptionsBlock=$(t()).prependTo(this.$itemOptionsBlock);this.$scalesSelectBlock=$(r()).prependTo(this.$itemOptionsBlock);this.$TuningOptionsBlock=$(q()).prependTo(this.$itemOptionsBlock);
this.$rootNotesBlocks=$(".root_note",".scale_notes_and_semitones_block",this.$itemBlock)};Z.prototype.updateNoteNotation=function(){this.$rootNotesBlocks.each(function(){var a=$(this),b=new C(a.text());S&&(b=(new C(a.text())).normalSharpToFlat());a.text(b)});this.updateScaleNotesBlock();this.neck.updateNoteNotation()};
Z.prototype.init=function(){this.initDOM();this.neck=new X(this.state,this.$neckBlock,$(".strings_number",this.$itemBlock),$(".add_string",this.$itemBlock),$(".delete_string",this.$itemBlock),$(".tuning_options",this.$itemBlock),this.$lhToggleBlock);this.initTriadsCheckbox();this.updateScaleNotesBlock();this.selectCurrentScale();this.selectCurrentRootNote();$(".scale_select",this.$itemBlock).change({that:this},this.onScaleChange);$(".scale_notes_and_semitones_block",this.$itemBlock).on("click",".root_note",
{that:this},this.onRootNoteChange)};itemsFactory={getItem:function(a,b){var c=[],d="";if(b)try{c=JSON.parse(b),d=c[0]}catch(f){console.error("Invalid JSON: "+b)}switch(d){case "scales":a=new Z(a,b);break;case "chords":a=new ChordsItem(a,b);break;default:d&&console.error("Invalid item type: "+d),a=new Z(a)}return a}};var T={itemsNumber:0,items:{},itemsSerializedStates:{},getIDforNewItem:function(){for(var a=0;void 0!==this.items["menuItem"+a];)a++;return"menuItem"+a},deleteItem:function(a){5==this.itemsNumber&&this.$addNewItemBtn.show(0);delete this.items[a]&&(delete this.itemsSerializedStates[a],this.updateItemsQueryParams(),this.itemsNumber--)},hideAddItemBtnIf:function(){5<=this.itemsNumber&&this.$addNewItemBtn.hide(0)},updateItemsQueryParams:function(){for(var a="?",b=0;5>b;b++){var c="menuItem"+b;void 0!==
this.itemsSerializedStates[c]&&(0!=b&&(a+="&"),a+="i"+b+"="+this.encodeQueryParamString(this.itemsSerializedStates[c]))}history.replaceState({},"",a)},updateItemSerializedData:function(a,b){this.itemsSerializedStates[a]=b},createNewItem:function(){var a=this.getIDforNewItem();5>this.itemsNumber&&(this.items[a]=new U(a),this.itemsNumber++);this.hideAddItemBtnIf()},createItemsFromQueryParams:function(a){for(var b=0;b<a.length&&5>b;b++){var c=this.getIDforNewItem();this.items[c]=new U(c,a[b]);this.itemsNumber++}this.hideAddItemBtnIf()},
readItemsQueryParams:function(){var a=window.location.href,b=a.indexOf("?"),c=[];if(-1!=b){a=a.slice(b+1).split("&");for(var d=0;d<a.length&&5>d;d++)b=a[d].indexOf("="),-1!=b&&(b=a[d].slice(b+1),b=this.decodeQueryParamString(b),c.push(b))}return c},encodeQueryParamString:function(a){var b="",c=a[a.length-1];"["==a[0]&&"]"==c&&(a=a.replace(/\[/g,"(").replace(/\]/g,")"),b=a.replace(/["']/g,""));return b},decodeQueryParamString:function(a){var b="",c=a[a.length-1];"("==a[0]&&")"==c&&(a=a.replace(/\(/g,
"[").replace(/\)/g,"]"),b=a.replace(/[^\d,\[\]"'-]\w*#*/g,function(a){return'"'+a+'"'}));return b},onNewItemButton:function(a){that=a.data.that;that.createNewItem()},updateNoteNotation:function(){for(id in this.items)this.items[id].updateNoteNotation()},init:function(){this.$addNewItemBtn=$("#add_new_item_btn");this.$addNewItemBtn.click({that:this},this.onNewItemButton);var a=this.readItemsQueryParams();0==a.length?this.createNewItem():this.createItemsFromQueryParams(a)}};window.onload=function(){ba.init()};I.init();T.init();ca.init();}).call(this);
